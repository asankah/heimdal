########################################################################
#
# Copyright (c) 2010, Secure Endpoints Inc.
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 
# - Redistributions of source code must retain the above copyright
#   notice, this list of conditions and the following disclaimer.
# 
# - Redistributions in binary form must reproduce the above copyright
#   notice, this list of conditions and the following disclaimer in
#   the documentation and/or other materials provided with the
#   distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
# BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
# ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
# 

RELDIR=packages\windows\installer

!include ../../../windows/NTMakefile.w32

VERSIOND=$(VER_PRODUCT_MAJOR)-$(VER_PRODUCT_MINOR)-$(VER_PRODUCT_AUX)-$(VER_PRODUCT_PATCH)
VERSION=$(VER_PRODUCT_MAJOR).$(VER_PRODUCT_MINOR).$(VER_PRODUCT_AUX).$(VER_PRODUCT_PATCH)

!if "$(CPU)"=="AMD64"
PLATFORM=x64
!else
PLATFORM=x86
!endif

MERGEMOD=$(INSTDIR)\Heimdal.msm

$(MERGEMOD): $(OBJ)\heimdal-assemblies.wixobj
	$(LIGHT) -out $@ $**

$(OBJ)\heimdal-assemblies.wixobj: heimdal-assemblies.wxs
	$(CANDLE) -arch $(PLATFORM) -o $@ $** \
		-dVersion=$(VERSION)	\
		-dBinDir=$(BINDIR)	\
		-dPlatform=$(PLATFORM)

all:: $(MERGEMOD)

clean::
	-$(RM) $(MERGEMOD)

!if exist($(SRC)\thirdparty)
THIRDPARTYOBJS=$(INSTDIR)\apicache.wixobj $(INSTDIR)\lsacache.wixobj
THIRDPARTYDEPS=$(INSTDIR)\Heimdal-krbcompat.msm
THIRDPARTYOPT=-dApiCache=1 -dLsaCache=1 -dKrbCompat=1
!endif

INSTALLER=$(INSTDIR)\Heimdal.msi

RUNTIMEMODULE="$(MSSDK)\Redist\VC\microsoft.vcxx.crt.$(PLATFORM)_msm.msm"

$(INSTALLER): $(OBJ)\heimdal-installer.wixobj $(MERGEMOD) $(THIRDPARTYOBJS) $(THIRDPARTYDEPS)
	$(LIGHT) -out $@ $(OBJ)\heimdal-installer.wixobj $(THIRDPARTYOBJS) -sval
	$(_CODESIGN)

$(OBJ)\heimdal-installer.wixobj: heimdal-installer.wxs
	$(CANDLE) -arch $(PLATFORM) -o $@ $** \
		-dVersion=$(VERSION)	\
		-dBinDir=$(BINDIR)	\
		-dInstDir=$(INSTDIR)	\
		-dSrcDir=$(SRC)		\
		-dPlatform=$(PLATFORM)	\
		-dRuntimeModule=$(RUNTIMEMODULE) \
		$(THIRDPARTYOPT)

all:: $(INSTALLER)

clean::
	-$(RM) $(INSTALLER)